# Adds another server on port 80 for Onion Service hosting
#
# This does not configure the Tor daemon, which should be done separately.
#
# See https://meta.discourse.org/t/template-for-serving-through-an-onion-address-with-docker/41536
#     https://meta.discourse.org/t/how-to-create-mirror-in-tor-with-onion-domain/220292

run:
  - exec:
      cmd:
        # Check DISCOURSE_ONION variable has been configured
        - if [ -z "$DISCOURSE_ONION" ]; then echo "DISCOURSE_ONION ENV variable is required and has not been set."; exit 1; fi

  - exec:
      cmd:
        # Copy default nginx file
        - "cp $home/config/nginx.sample.conf /etc/nginx/conf.d/onion.conf"

  # Remove duplicate entries that would crash the server
  - replace:
      filename: "/etc/nginx/conf.d/onion.conf"
      from: /upstream[^\}]+\}/m
      to: ""

  - replace:
      filename: "/etc/nginx/conf.d/onion.conf"
      from: /map[^\}]+\}/m
      to: ""

  - replace:
      filename: "/etc/nginx/conf.d/onion.conf"
      from: /types[^\}]+\}/m
      to: ""

  - replace:
      filename: "/etc/nginx/conf.d/onion.conf"
      from: /proxy_cache_path.*$/
      to: ""

  - replace:
      filename: "/etc/nginx/conf.d/onion.conf"
      from: /proxy_buffer_size.*$/
      to: ""

  - replace:
      filename: "/etc/nginx/conf.d/onion.conf"
      from: /proxy_buffers.*$/
      to: ""

  - replace:
      filename: "/etc/nginx/conf.d/onion.conf"
      from: /large_client_header_buffers.*$/
      to: ""

  - replace:
      filename: "/etc/nginx/conf.d/onion.conf"
      from: /log_format.*$/
      to: ""

  # Set the Onion Service address
  - replace:
      filename: "/etc/nginx/conf.d/onion.conf"
      from: /server_name.+$/
      to: server_name $$ENV_DISCOURSE_ONION;

  # Apply the same replacements done on web.template.yml to the nginx file
  - replace:
      filename: "/etc/nginx/conf.d/onion.conf"
      from: /client_max_body_size.+$/
      to: client_max_body_size $upload_size ;

  # Ensure an appropriate bucket size for the server names hash tables
  - file:
     path: /etc/nginx/conf.d/server_names_hash_bucket_size.conf
     contents: |
       server_names_hash_bucket_size 128;
